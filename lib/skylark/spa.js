/**
 * skylark - An Elegant JavaScript Library and HTML5 Application Framework.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark/skylark","skylark/langx","skylark/eventer","skylark/router","skylark/velm","skylark/finder","skylark/noder","skylark/async"],function(t,r,e,n,i,o,a,s){var u,l=s.Deferred,c=n.Route=n.Route.inherit({klassName:"SpaRoute",init:function(t,e){this.overrided(t,e),this.content=e.content,this.data=e.data;var n=this;["preparing","rendering","rendered"].forEach(function(t){r.isFunction(e[t])&&n.on(t,e[t])})},_entering:function(t){return this._prepared?this:this.prepare()},getConfigData:function(t){return t?this.data[t]:this.data},prepare:function(){var t=new l,r=this._setting,i=r.controller,o=this.controller,a=this;r.content,r.contentPath;return i&&!o?require([i.type],function(r){o=a.controller=new r(i),t.resolve()}):t.resolve(),t.then(function(){var t=e.create("preparing",{route:a,result:!0});return e.trigger(a,t),l.when(t.result).then(function(){e.trigger(n.hub(),"prepared",{route:a}),a._prepared=!0})})},render:function(t){var r=e.create("rendering",{route:this,context:t,content:this.content});return e.trigger(this,r),r.content},trigger:function(t){var r=this.controller;return r?r.perform(t):this.overrided(t)}}),h=r.klass({klassName:"SpaRouteController",init:function(t,r){r=r||{},this.content=r.content,this.data=r.data},getConfigData:function(t){return t?this.data[t]:this.data},perform:function(t){var r=t.type;if(this[r])return this[r].call(this,t)}}),p=r.klass({klassName:"SpaPage",init:function(t){t=r.mixin({routeViewer:"body"},t),this._params=t,this._$rvc=i.find(t.routeViewer),this._router=n,n.on("routing",r.proxy(this,"refresh"))},prepare:function(){},refresh:function(){var t=n.current();n.previous();this._$rvc.html(t.route.render(t))}}),f=r.klass({klassName:"SpaPlugin",init:function(t,r){this.name=t,this._setting=r},prepare:function(){var t=new l,i=this._setting,o=i.controller,a=this.controller,s=this;return o&&!a?require([o.type],function(e){a=s.controller=new e(o),n.on(i.hookers,{plugin:s},r.proxy(a.perform,a)),t.resolve()}):(r.each(i.hookers,function(t,r){n.on(t,{plugin:s},r)}),t.resolve()),t.then(function(){var t=e.create("preparing",{result:!0});return e.trigger(s,t),l.when(t.result).then(function(){s._prepared=!0})})},trigger:function(t,n){return e.trigger(new r.Evented,t,n),this}}),g=r.klass({klassName:"SpaPluginController",init:function(t){this.plugin=t},perform:function(t){var r=t.type;if(this[r])return this[r].call(this,t)}}),d=r.Evented.inherit({klassName:"SpaApplication",init:function(t){if(u)return u;var e=this._plugins={};t=this._config=r.mixin({plugins:{}},t,!0),r.each(t.plugins,function(t,r){e[t]=new f(t,r)}),n.routes(t.routes),this._router=n,this._page=new k.Page(t.page),document.title=t.title;var i=t.baseUrl;void 0===i&&(i=t.baseUrl=require.toUrl("")),n.baseUrl(i),t.homePath&&n.homePath(t.homePath),u=this},getConfig:function(t){return t?this._config[t]:this._config},go:function(t){return n.go(t),this},page:function(){return this._page},prepare:function(){var t=this,i=r.map(n.routes(),function(t,r){if(t.lazy===!1)return t.prepare()}),o=r.map(this._plugins,function(t,r){return t.prepare()});return l.all(i.concat(o)).then(function(){return e.trigger(n,"starting",{spa:t})})},run:function(){this._router.start()}}),k=function(t){return u||(window[t.name||"app"]=u=new k.Application(t)),u};return r.mixin(k,{Application:d,Page:p,Plugin:f,PluginController:g,Route:c,RouteController:h,velm:i}),t.spa=k});